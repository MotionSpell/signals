#!/usr/bin/env bash
set -euo pipefail

export EXTRA=${EXTRA-$PWD/sysroot}
export PKG_CONFIG_PATH=$EXTRA/lib/pkgconfig:${PKG_CONFIG_PATH-}

echo '# config file'
echo '# packages: $PKGS'

readonly PKGS="$@"
if [ ! -z "$PKGS" ] ; then
  if ! pkg-config --exists "$PKGS" ; then
    echo "Some packages were not found:" >&2
    for pkg in $PKGS ; do
      if ! pkg-config --exists "$pkg" ; then
        echo "* $pkg" >&2
      fi
    done
    exit 1
  fi

  echo -n 'CFLAGS+='
  pkg-config --cflags "$PKGS"

  echo -n 'LDFLAGS+='
  pkg-config --libs "$PKGS"
fi

echo "CFLAGS+= -I$EXTRA/include/asio -Wno-unused-local-typedefs"
echo "LDFLAGS+= -lpthread"

# Workaround: linking with libgpac and libavfilter currently requires this,
# otherwise link fails with undefined references to libass, libjpeg and libpng.
# (extra.sh builds libgpac/libavfilter with 'rpath' options, this might be root cause).
echo "LDFLAGS+=-Wl,-rpath,$EXTRA/lib"

